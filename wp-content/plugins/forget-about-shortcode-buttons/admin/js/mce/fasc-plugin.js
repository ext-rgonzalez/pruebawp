/* global tinymce */

/**
 * WordPress View plugin.
 */
!function(){tinymce.PluginManager.add("fascview",function(a){function q(a){a.stopPropagation()}function s(){var b=tinymce.activeEditor.dom.select(".fasc-button"),c=!1;jQuery(b).each(function(){if(jQuery(this).is("[data-fasc-style]")){var b=jQuery(this).attr("data-fasc-style").replace(/\s+/,""),d="";jQuery(this).is("[style]")&&(d=jQuery(this).attr("style").replace(/\s+/,"")),b!=d&&(jQuery(this).attr("style",jQuery(this).attr("data-fasc-style")),a.nodeChanged(),c=!0)}})}function t(b){a.undoManager.transact(function(){a.dom.remove(b),v(),a.focus()})}function u(b){var e=a.dom;b&&(b!==c&&(a.getBody().focus(),v(),c=b,e.setAttrib(b,"data-mce-selected",1)),a.nodeChanged())}function v(){var d=a.dom;c&&(d.unbind(c,"beforedeactivate focusin focusout click mouseup",q),d.setAttrib(c,"data-mce-selected",null)),c=null}function w(c){var d=b(c),e=d.find(".fasc-button");return console.log("found fasc button: "),console.log(e),b(e).each(function(){var a=b(this),c=a.attr("data-fasc-href");a.attr("data-fasc-temp",null),a.attr("data-fasc-style",null),void 0!==c&&(a.attr("href",c),a.attr("data-fasc-href",null))}),a.dom.getOuterHTML(d)}function x(){for(var b=a.dom.select(".fasc-button"),c=0;c<b.length;c++){var d=b[c],e=a.dom.getAttrib(d,"href");""==a.dom.getAttrib(d,"data-fasc-href")&&""!=e&&(a.dom.setAttrib(d,"data-fasc-href",e),a.dom.setAttrib(d,"href",""))}}function y(a,b,c,d,e){if(void 0===e)var e="";"function"!=typeof d&&(d=function(d,e){var f=a.$(d);c?a.$(b).replaceWith(f):a.selection.setContent(d);a.$("[data-fasc-id='"+e+"']");v(),a.focus(),a.nodeChanged(),u(a.dom.select("a[data-fasc-id='"+e+"']")[0])}),wp.mce.fascpopup.open(b,"button",d,c,e)}var c,k,l,m,p,b=a.$,h=(tinymce.Env,tinymce.util.VK,tinymce.dom.TreeWalker,!0),i=function(){return!1};/iPad|iPod|iPhone/.test(navigator.userAgent);if("undefined"==typeof wp||!wp.mce)return{getView:i};a.on("SetContent",function(){x()}),a.on("init",function(){a.on("dblClick",function(b){if(a.dom.hasClass(b.target,"fasc-button"))return b.preventDefault(),y(a,b.target,!0),!1},!0),a.addCommand("popup_insert_fasc_button",function(b,c){var d=!1;a.dom.hasClass(a.selection.getNode(),"fasc-button")&&(d=!0);var e=a.selection.getContent({format:"text"});y(a,a.selection.getNode(),d,{},e)});var b=!1;a.selection,window.MutationObserver||window.WebKitMutationObserver;a.dom.bind(a.getDoc(),"touchmove",function(){b=!0}),a.on("mousedown mouseup click touchend",function(c){h=!1,a.dom.hasClass(c.target,"fasc-button")?"touchend"===c.type&&b?b=!1:u(c.target):"touchend"!==c.type&&"mousedown"!==c.type||v(),"touchend"===c.type&&b&&(b=!1)},!0)}),a.on("PreProcess",function(a){},!0),a.on("hide",function(){v()}),a.on("PostProcess",function(a){a.content&&(a.content=w(a.content))}),a.on("keydown",function(c){if(v(),32==c.keyCode&&a.dom.hasClass(a.selection.getNode(),"fasc-button")){if(a.selection.getRng().startOffset==b(a.selection.getNode()).text().length){var f=tinymce.DOM.uniqueId(),g=a.dom.create("span",{id:f},"&nbsp;");a.dom.insertAfter(g,a.selection.getNode());var h=a.dom.select("span#"+f);return a.selection.select(h[0]),a.selection.collapse(0),a.dom.setAttrib(f,"id",""),!1}}}),a.on("focus",function(){m=!0,h=!1}),a.on("blur",function(){m=!1}),a.on("NodeChange",function(b){a.dom,a.dom.select(".fascview-wrap"),b.element.className;l=!1,clearInterval(k)}),a.on("BeforeExecCommand",function(){a.selection.getNode()}),a.on("ExecCommand",function(){}),a.on("ResolveName",function(a){}),a.on("PastePostProcess",function(){s()}),a.addButton("fasc_view_edit",{tooltip:"Edit ",icon:"dashicon dashicons-edit",onclick:function(){c&&y(a,c,!0)}}),a.addButton("fasc_view_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){c&&t(c)}}),a.once("preinit",function(){a.wp&&a.wp._createToolbar&&(p=a.wp._createToolbar(["fasc_view_edit","fasc_view_remove"]))}),a.on("wptoolbar",function(a){c&&(a.element=c,a.toolbar=p)}),a.wp=a.wp||{}})}();